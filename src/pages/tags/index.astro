---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = true;

// Get all Q&A entries to calculate tag counts
const allQuestions = await getCollection('qa');

// Calculate tag counts
const tagCounts = new Map<string, number>();
allQuestions.forEach(question => {
  question.data.tags.forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

// Sort tags by count (descending) then alphabetically
const sortedTags = Array.from(tagCounts.entries())
  .sort((a, b) => {
    if (a[1] !== b[1]) {
      return b[1] - a[1]; // Sort by count descending
    }
    return a[0].localeCompare(b[0], 'ar'); // Then alphabetically in Arabic
  });

const totalQuestions = allQuestions.length;

// Helper function to get Arabic count text
function getCountText(count: number): string {
  if (count === 1) return 'سؤال';
  if (count === 2) return 'سؤالان';
  if (count <= 10) return 'أسئلة';
  return 'سؤالاً';
}
---

<BaseLayout 
  title="الوسوم"
  description="تصفح جميع الوسوم المتاحة في موقع الأسئلة والأجوبة. اكتشف المواضيع المختلفة وابحث عن الأسئلة حسب اهتماماتك."
>
  <div class="space-y-8">
    <!-- Header Section -->
    <div class="text-center space-y-4">
      <h1 class="text-3xl md:text-4xl font-bold text-zinc-900 dark:text-zinc-100">
        الوسوم
      </h1>
      <p class="text-lg text-zinc-600 dark:text-zinc-300 max-w-2xl mx-auto">
        استكشف المواضيع المختلفة في موقعنا من خلال الوسوم. كل وسم يجمع الأسئلة المتعلقة بموضوع معين لتسهيل العثور على المحتوى الذي تبحث عنه.
      </p>
      <div class="text-sm text-zinc-500 dark:text-zinc-400">
        المجموع: {totalQuestions} سؤال في {sortedTags.length} وسم
      </div>
    </div>

    <!-- Tags Grid -->
    <div class="space-y-6">
      <h2 class="text-xl font-semibold text-zinc-900 dark:text-zinc-100 border-b border-zinc-200 dark:border-zinc-800 pb-2">
        جميع الوسوم
      </h2>
      
      {sortedTags.length > 0 ? (
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {sortedTags.map(([tag, count]) => (
            <a 
              href={`/tags/${encodeURIComponent(tag)}`}
              class="group block p-4 bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 hover:shadow-md hover:border-indigo-300 dark:hover:border-indigo-600 transition-all duration-200 hover:-translate-y-0.5"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-medium text-zinc-900 dark:text-zinc-100 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors truncate">
                    #{tag}
                  </h3>
                  <p class="text-sm text-zinc-500 dark:text-zinc-400 mt-1">
                    {count} {getCountText(count)}
                  </p>
                </div>
                <div class="flex-shrink-0 mr-3">
                  <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center group-hover:bg-indigo-200 dark:group-hover:bg-indigo-900/50 transition-colors">
                    <span class="text-indigo-600 dark:text-indigo-400 text-sm font-semibold">
                      {count}
                    </span>
                  </div>
                </div>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="text-zinc-400 dark:text-zinc-500 text-lg">
            لا توجد وسوم متاحة حالياً
          </div>
        </div>
      )}
    </div>

    <!-- Popular Tags Section -->
    {sortedTags.length > 0 && (
      <div class="space-y-4">
        <h2 class="text-xl font-semibold text-zinc-900 dark:text-zinc-100 border-b border-zinc-200 dark:border-zinc-800 pb-2">
          الوسوم الأكثر شيوعاً
        </h2>
        <div class="flex flex-wrap gap-2">
          {sortedTags.slice(0, 10).map(([tag, count]) => (
            <a 
              href={`/tags/${encodeURIComponent(tag)}`}
              class="inline-flex items-center px-3 py-2 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors"
            >
              #{tag}
              <span class="mr-1.5 text-xs opacity-75">({count})</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Navigation Help -->
    <div class="bg-zinc-100 dark:bg-zinc-900/50 rounded-lg p-6 space-y-3">
      <h3 class="text-lg font-medium text-zinc-900 dark:text-zinc-100">
        كيفية استخدام الوسوم
      </h3>
      <ul class="space-y-2 text-sm text-zinc-600 dark:text-zinc-300">
        <li class="flex items-start">
          <span class="text-indigo-500 ml-2">•</span>
          انقر على أي وسم لعرض جميع الأسئلة المتعلقة به
        </li>
        <li class="flex items-start">
          <span class="text-indigo-500 ml-2">•</span>
          الوسوم مرتبة حسب عدد الأسئلة من الأكثر إلى الأقل
        </li>
        <li class="flex items-start">
          <span class="text-indigo-500 ml-2">•</span>
          يمكنك استخدام الوسوم لاكتشاف مواضيع جديدة ومثيرة للاهتمام
        </li>
      </ul>
    </div>
  </div>
</BaseLayout>