---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import CardQuestion from '../components/CardQuestion.astro';
import SearchBanner from '../components/SearchBanner.jsx';

// Get search query and pagination from URL parameters
const url = Astro.url;
const searchQuery = url.searchParams.get('q') || '';
const trimmedQuery = searchQuery.trim();
const page = Math.max(1, parseInt(url.searchParams.get('page') || '1'));
const limit = 12; // Results per page

// Database search results
let searchResults: any = {
  suggestions: [],
  pagination: { page: 1, limit, total: 0, hasMore: false },
  searchInfo: { query: trimmedQuery, resultsCount: 0 }
};
let searchPerformed = false;
let searchError = false;

if (trimmedQuery.length >= 2) {
  searchPerformed = true;
  
  try {
    // Call database-backed search API
    const searchUrl = new URL('/api/search', Astro.url.origin);
    searchUrl.searchParams.set('q', trimmedQuery);
    searchUrl.searchParams.set('page', page.toString());
    searchUrl.searchParams.set('limit', limit.toString());
    
    const response = await fetch(searchUrl.toString());
    
    if (response.ok) {
      searchResults = await response.json();
    } else {
      console.error('Search API error:', response.status, response.statusText);
      
      // If database is not configured (503), provide a more helpful message
      if (response.status === 503) {
        console.warn('Database not configured, search functionality limited');
      }
      
      searchError = true;
    }
  } catch (error) {
    console.error('Search request failed:', error);
    searchError = true;
  }
}

// SEO meta data
const title = searchPerformed 
  ? `نتائج البحث عن "${trimmedQuery}" - موقع الأسئلة والأجوبة`
  : 'البحث في الأسئلة والأجوبة';
const description = searchPerformed
  ? `نتائج البحث عن "${trimmedQuery}" في موقع الأسئلة والأجوبة. ${searchResults.pagination.total} نتيجة متاحة.`
  : 'ابحث في مجموعة شاملة من الأسئلة والأجوبة باللغة العربية. اكتشف الإجابات التي تحتاجها.';

// Popular search suggestions (fallback to content collections for popular tags)
const allQuestions = await getCollection('qa');
const tagCounts = new Map<string, number>();
allQuestions.forEach((question) => {
  question.data.tags.forEach((tag) => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

const popularSearches = Array.from(tagCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 8)
  .map(([tag]) => tag);
---

<BaseLayout title={title} description={description}>
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-zinc-900 dark:text-zinc-100 mb-4">
      {searchPerformed ? 'نتائج البحث' : 'البحث في الأسئلة'}
    </h1>
    
    {searchPerformed && (
      <div class="mb-6">
        <p class="text-zinc-600 dark:text-zinc-300 text-lg mb-2">
          نتائج البحث عن: <span class="font-semibold text-indigo-600 dark:text-indigo-400">"{trimmedQuery}"</span>
        </p>
        <div class="text-sm text-zinc-500 dark:text-zinc-400">
          {searchError 
            ? 'حدث خطأ في البحث' 
            : searchResults.suggestions.length === 0 
              ? 'لا توجد نتائج' 
              : `${searchResults.pagination.total} ${searchResults.pagination.total === 1 ? 'نتيجة' : 'نتيجة'} متاحة`
          }
        </div>
      </div>
    )}

    <!-- Search Banner -->
    <div class="mb-8">
      <SearchBanner 
        client:load 
        placeholder="ابحث في الأسئلة..." 
        maxSuggestions={5} 
        className="w-full max-w-2xl mx-auto"
      />
    </div>
  </div>

  <!-- Search Results -->
  {searchPerformed ? (
    searchError ? (
      <!-- Search Error State -->
      <div class="text-center py-12">
        <div class="max-w-md mx-auto">
          <div class="mx-auto w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mb-6">
            <svg class="w-8 h-8 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-zinc-900 dark:text-zinc-100 mb-3">
            البحث غير متاح حالياً
          </h2>
          <p class="text-zinc-600 dark:text-zinc-300 mb-6">
            نعتذر، خدمة البحث غير متاحة حالياً. يمكنك تصفح المحتوى مباشرة من خلال الروابط أدناه.
          </p>
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <button
              onclick="window.location.reload()"
              class="inline-flex items-center justify-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-medium rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 hover:scale-105"
            >
              إعادة المحاولة
            </button>
            <a
              href="/questions"
              class="inline-flex items-center justify-center px-6 py-3 border border-zinc-300 dark:border-zinc-600 text-zinc-700 dark:text-zinc-300 bg-white dark:bg-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-700 font-medium rounded-lg transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 hover:scale-105"
            >
              تصفح الأسئلة
            </a>
          </div>
        </div>
      </div>
    ) : searchResults.suggestions.length > 0 ? (
      <>
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 mb-8">
          {searchResults.suggestions.map((question: any, index: number) => (
            <div onclick={`if (window.gtag) { window.gtag('event', 'select_item', { item_list_id: 'search_results', item_list_name: 'Search Results', item_id: '${question.slug}', item_name: '${question.question.replace(/'/g, "\\'")}', index: ${index + 1}, search_term: '${trimmedQuery.replace(/'/g, "\\'")}', language: 'ar' }); }`}>
              <CardQuestion
                href={`/q/${question.slug}`}
                title={question.question}
                description={question.short_answer}
                date={new Date(question.pub_date)}
                tags={question.tags}
                difficulty={question.difficulty}
              />
            </div>
          ))}
        </div>
        
        <!-- Pagination -->
        {searchResults.pagination.total > limit && (
          <div class="flex justify-center items-center gap-4 mb-12">
            <div class="flex items-center gap-2">
              <!-- Previous Page -->
              {page > 1 && (
                <a
                  href={`/search?q=${encodeURIComponent(trimmedQuery)}&page=${page - 1}`}
                  class="inline-flex items-center gap-2 px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 rounded-md"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                  </svg>
                  السابق
                </a>
              )}
              
              <!-- Page Info -->
              <div class="px-4 py-2 text-sm text-zinc-600 dark:text-zinc-400">
                صفحة {page} من {Math.ceil(searchResults.pagination.total / limit)}
              </div>
              
              <!-- Next Page -->
              {searchResults.pagination.hasMore && (
                <a
                  href={`/search?q=${encodeURIComponent(trimmedQuery)}&page=${page + 1}`}
                  class="inline-flex items-center gap-2 px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 rounded-md"
                >
                  التالي
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
              )}
            </div>
          </div>
        )}
      </>
    ) : (
      <!-- No Results State -->
      <div class="text-center py-12">
        <div class="max-w-md mx-auto">
          <!-- Search Icon -->
          <div class="mx-auto w-16 h-16 bg-zinc-100 dark:bg-zinc-800 rounded-full flex items-center justify-center mb-6">
            <svg class="w-8 h-8 text-zinc-400 dark:text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          
          <h2 class="text-xl font-semibold text-zinc-900 dark:text-zinc-100 mb-3">
            لا توجد نتائج لـ "{trimmedQuery}"
          </h2>
          
          <p class="text-zinc-600 dark:text-zinc-300 mb-6">
            لم نتمكن من العثور على أي أسئلة تطابق بحثك. جرب البحث بكلمات مختلفة أو تصفح المواضيع الشائعة أدناه.
          </p>

          <!-- Search Suggestions -->
          <div class="mb-6">
            <h3 class="text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-3">جرب البحث عن:</h3>
            <div class="flex flex-wrap gap-2 justify-center">
              {popularSearches.slice(0, 6).map((tag) => (
                <a
                  href={`/search?q=${encodeURIComponent(tag)}`}
                  class="inline-flex items-center px-3 py-1.5 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 font-medium rounded-md transition-all duration-200 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 hover:scale-105"
                >
                  {tag}
                </a>
              ))}
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a
              href="/questions"
              class="inline-flex items-center justify-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-medium rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 hover:scale-105"
            >
              تصفح جميع الأسئلة
            </a>
            <a
              href="/tags"
              class="inline-flex items-center justify-center px-6 py-3 border border-zinc-300 dark:border-zinc-600 text-zinc-700 dark:text-zinc-300 bg-white dark:bg-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-700 font-medium rounded-lg transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 hover:scale-105"
            >
              تصفح المواضيع
            </a>
          </div>
        </div>
      </div>
    )
  ) : (
    <!-- Initial Search State -->
    <div class="text-center py-12">
      <div class="max-w-2xl mx-auto">
        <h2 class="text-2xl font-semibold text-zinc-900 dark:text-zinc-100 mb-4">
          ابحث في مكتبة الأسئلة والأجوبة
        </h2>
        
        <p class="text-zinc-600 dark:text-zinc-300 text-lg mb-8">
          اكتشف إجابات لأسئلتك من خلال البحث في مجموعة شاملة من المحتوى التعليمي باللغة العربية
        </p>

        <!-- Popular Searches -->
        <div class="mb-8">
          <h3 class="text-lg font-medium text-zinc-700 dark:text-zinc-300 mb-4">المواضيع الشائعة:</h3>
          <div class="flex flex-wrap gap-3 justify-center">
            {popularSearches.map((tag) => (
              <a
                href={`/search?q=${encodeURIComponent(tag)}`}
                class="inline-flex items-center px-4 py-2 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-600 hover:shadow-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 hover:scale-105"
              >
                <span class="text-zinc-700 dark:text-zinc-300 font-medium">#{tag}</span>
              </a>
            ))}
          </div>
        </div>

        <!-- Navigation Links -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="/questions"
            class="inline-flex items-center justify-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-medium rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 hover:scale-105"
          >
            تصفح جميع الأسئلة
          </a>
          <a
            href="/tags"
            class="inline-flex items-center justify-center px-6 py-3 border border-zinc-300 dark:border-zinc-600 text-zinc-700 dark:text-zinc-300 bg-white dark:bg-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-700 font-medium rounded-lg transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 hover:scale-105"
          >
            تصفح حسب الموضوع
          </a>
        </div>
      </div>
    </div>
  )}

  <!-- Back to Home -->
  <div class="text-center mt-12">
    <a
      href="/"
      class="inline-flex items-center gap-2 px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-indigo-400 dark:focus-visible:ring-offset-zinc-950 rounded-md"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      العودة للرئيسية
    </a>
  </div>

  <!-- Google Analytics Search Tracking -->
  {searchPerformed && !searchError && (
    <script is:inline define:vars={{ 
      searchQuery: trimmedQuery, 
      resultsCount: searchResults.pagination.total,
      hasResults: searchResults.suggestions.length > 0
    }}>
      // Track search results page view
      if (typeof window !== 'undefined' && window.gtag) {
        window.gtag('event', 'search', {
          search_term: searchQuery,
          custom_parameter_1: resultsCount.toString(),
          custom_parameter_2: hasResults ? 'has_results' : 'no_results',
          content_type: 'search_results_page',
          language: 'ar'
        });
      }
    </script>
  )}
</BaseLayout>